---
title: "Jc Transportes - Tratamento dos bancos de dados"
output: html_notebook
---

```{r, warning = FALSE}
library(dplyr)
library(here)
library(data.table)
library(readxl)  
library(tools)   
library(httr)
library(jsonlite)
library(bigrquery)
library(basedosdados)
```

```{r, warning = FALSE}
# Lendo arquivos CSV 
csv_files <- list.files(here("Dados"), pattern = "\\.csv$", full.names = TRUE)

csv_data <- lapply(csv_files, read.csv2, encoding = "latin1")

names(csv_data) <- csv_files %>%
  basename() %>%
  file_path_sans_ext()

# Read XLSX
xlsx_files <- list.files(here("Dados"), pattern = "\\.xls[x]?$", full.names = TRUE)

xlsx_data <- lapply(xlsx_files, read_excel)
names(xlsx_data) <- xlsx_files %>%
  basename() %>%
  file_path_sans_ext()

# Optional: Combine all into one list
all_data <- c(csv_data, xlsx_data)

#Removendo demais vari√°veis
rm(csv_data, csv_files, xlsx_data, xlsx_files)
```

```{r}
#Corrigir os arquivos csv:
all_data <- lapply(all_data, function(df) {
  if (ncol(df) == 1) {
    raw_text <- df[[1]]
    parsed_df <- read.csv(text = raw_text, header = TRUE, stringsAsFactors = FALSE)
    return(parsed_df)
  } else {
    return(df)
  }
})
```

## Base de Munic√≠pios e Anos

```{r}
#Base dos munic√≠pios
df <- all_data$RELATORIO_DTB_BRASIL_2024_MUNICIPIOS %>% 
  data.table()

#Ajustando a base
header_df <- as.character(df[6, ])
df <- df[7:nrow(df), ]
colnames(df) <- header_df

df <- df %>% 
  select(`C√≥digo Munic√≠pio Completo`, Nome_Munic√≠pio) %>% 
  rename(i_CodIBGE = `C√≥digo Munic√≠pio Completo`, 
         i2_Nome_Municipio = Nome_Munic√≠pio)

df <- expand.grid(
  i_CodIBGE = unique(df$i_CodIBGE),
  t_Ano = 2005:2024,
  stringsAsFactors = FALSE
) %>%
  merge(df, by = "i_CodIBGE", all = TRUE) %>%
  data.table(key = c("i_CodIBGE", "t_Ano"))

df[,i_CodIBGE := as.numeric(i_CodIBGE)]



rm(header_df)
```

# Vari√°veis explicativas

## x1: Munic√≠pios com Transporte P√∫blico Intramunicipal

```{r}
#Levantando a base
x1 <- read_excel(here("Dados/Base_MUNIC_2020.xlsx"), sheet = "Transporte") %>% 
  data.table()

#Selecionando colunas de interesse
x1 <- x1[, .("i_CodIBGE" = CodMun, 
       UF, 
       Regiao,
       Faixa_pop,  
       "x1_Transporte_Publico" = Mtra19, 
       "x1_1TZ_Idosos" = Mtra201, 
       "x1_2TZ_Estudantes_Publica" = Mtra202,
       "x1_3TZ_Estudantes_Privada" = Mtra203,
       "x1_4TZ_Carteiros" = Mtra204, 
       "x1_5TZ_PCD" = Mtra205, 
       "x1_6TZ_Policiais" = Mtra206, 
       "x1_7TZ_Professores" = Mtra207, 
       "x1_8TZ_Criancas" = Mtra208, 
       "x1_9TZ_Outros" = Mtra209, 
       "x1_10_TarifaZero_Todos" = Mtra2010)]

# Criando vari√°veis dummy
x1_cols <- grep("^x1", names(x1), value = TRUE)

x1[, (x1_cols) := lapply(.SD, function(x) {
  fifelse(x == "Sim", 1L,
  fifelse(x == "N√£o", 0L, NA_integer_))
}), .SDcols = x1_cols]

#Separando dados dos munic√≠pios
info_munic <- x1[, .(i_CodIBGE, UF, Regiao, Faixa_pop)]

#Adicionando ano:
x1[, "t_Ano" := 2020]

#Juntando √† base principal:
df <- merge(df, info_munic, by = c("i_CodIBGE"), all = T)
df <- merge(df, x1, by = c("i_CodIBGE", "t_Ano", "UF", "Regiao", "Faixa_pop"), all = T)


rm(x1_cols, info_munic, x1)
```

## x2: Tarifa Zero

```{r}
#Vari√°vel X2: Cidades com Tarifa Zero
x2 <- all_data$`cidades com tarifa zero universal no Brasil - 2025` %>% 
  data.table()

#Alterando nome das colunas
setnames(x2, c("C√≥digo IBGE", "In√≠cio", "Tipo"), 
         c("i_CodIBGE", "x2t1_Ano_TZ", "x2t2_Tipo_TZ"))


#Corrigindo coluna de ano de implementa√ß√£o
x2[, x2t1_Ano_TZ := as.integer(x2t1_Ano_TZ)]

#Removendo colunas que n√£o tem tarifa zero de √¥nibus:
x2 <- x2[x2t2_Tipo_TZ == "√înibus"]

#Selecionando colunas de interesse:
x2 <- x2[, .(i_CodIBGE, x2t1_Ano_TZ)]

#Juntando √† df
df <- merge(df, x2, by = "i_CodIBGE", all = T)

#Adicionando coluna dummy para presen√ßa de Tarifa Zero:
df <- df[, x2_TarifaZero := fifelse(t_Ano < x2t1_Ano_TZ | is.na(x2t1_Ano_TZ), 0,1)]


rm(x2)
```

# Vari√°veis Resposta

## y1: Emiss√£o de Gases de Efeito Estufa

```{r}
y1 <- read_excel(here("Dados/Dados municipais resumido - CO2e GWP-AR5 v12.0.xlsx"), sheet = "Dados") %>% 
  data.table()


#Selecionando colunas de interesse
cols_to_drop <- c(
  "Setor de emiss√£o",
  "Emiss√£o/Remo√ß√£o/Bunker",
  "Categoria emissora",
  "Sub-categoria emissora",
  "Recorte",
  "Estado",
  "Munic√≠pio")

y1 <- y1[, !..cols_to_drop]

#Pivotando as colunas de Anos
y1 <- melt(
  y1,
  id.vars = c("Atividade geral", "ID Territ√≥rio"),
  variable.name = "t_Ano",
  value.name = "y1_Emissoes_GEE")


#Sumarizando por grupos:
y1 <- y1[, .(
  y1_Emissoes_GEE = sum(y1_Emissoes_GEE, na.rm = TRUE)
), by = .(`Atividade geral`, `ID Territ√≥rio`, t_Ano)]

saveRDS(y1, here("DadosTratados/y1_EmissoesGEETratado.RDS"))

rm(cols_to_drop)
```

```{r}

#y1 <- readRDS(here("DadosTratados/y1_EmissoesGEETratado.RDS"))

#Selecionando dados de transporte:
y1 <- y1[,`Atividade geral` := fifelse(`Atividade geral` == "Transporte de passageiros", `Atividade geral`, "Outros")]


#Sumarizando por grupos:
y1 <- y1[, .(
  y1_Emissoes_GEE = sum(y1_Emissoes_GEE, na.rm = TRUE)
), by = .(`Atividade geral`, `ID Territ√≥rio`, t_Ano)]


#Separando os tipos de emiss√£o em diferentes colunas

y1 <- dcast(y1,
  `ID Territ√≥rio` + t_Ano ~ `Atividade geral`,
  value.var = "y1_Emissoes_GEE")

#Renomeando e ajustando o C√≥digo IBGE:
y1 <- y1[, .("i_CodIBGE" = substr(as.character(`ID Territ√≥rio`), 2, nchar(as.character(`ID Territ√≥rio`))),
       t_Ano, 
       "y1_1EGEE_Transporte" = `Transporte de passageiros`, 
       "y1_2EGEE_Outros" = Outros)]

#Substituindo NA por 0
y1 <- y1[, lapply(.SD, function(x) ifelse(is.na(x), 0, x)), keyby = c("i_CodIBGE", "t_Ano")]

#Criando coluna com total de emiss√µes
y1[, "y1_3SaldoTotal_EGEE" := sum(y1_1EGEE_Transporte, y1_2EGEE_Outros), by = c("i_CodIBGE", "t_Ano")]

y1[, t_Ano := as.numeric(as.character(t_Ano))]
y1[, i_CodIBGE := as.numeric(as.character(i_CodIBGE))]

#Substituindo 0 por NA
y1 <- y1[, lapply(.SD, function(x) fifelse(x == 0, NA, x)), keyby = c("i_CodIBGE", "t_Ano")]

#Juntando √† base original
df <- merge(df, y1, by = c("i_CodIBGE", "t_Ano"), all.x =T)


#Salvando a base atualizada

saveRDS(y1, here("DadosTratados/y1.RDS"))

#Removendo a base y1
rm(y1)

```

## y2: PIB per capita

```{r}

#Levantando a base
y2 <- read.csv(here("Dados/br_ibge_pib_municipio.csv"))

names(y2)
y2 <- y2 %>% 
  rename(i_CodIBGE = id_municipio,
    t_Ano = ano,
    y2_1PIBtotal = pib,
    y2_21VA_Total = va,
    y2_22VA_Agro = va_agropecuaria,
    y2_23VA_Industria = va_industria, 
    y2_24VA_Servicos = va_servicos,
    y2_25VA_SetorPublico = va_adespss, 
    y2_3impostos_liquidos = impostos_liquidos) %>% 
  data.table()


df <- merge(df, y2, by = c("i_CodIBGE", "t_Ano"), all.x = T)

rm(y2)

```

## y3: Volume de vendas por PIX:

```{r}
#Criando fun√ß√£o para obter dados do PIX por munic√≠pio
coletar_pix <- function(munic) {
  url <- paste0("https://olinda.bcb.gov.br/olinda/servico/Pix_DadosAbertos/versao/v1/odata/TransacoesPixPorMunicipio(DataBase=@DataBase)?@DataBase='202101'&$top=50&$filter=Municipio_Ibge%20eq%20", 
  munic, 
  "&$format=json&$select=AnoMes,Municipio_Ibge,VL_PagadorPF,QT_PagadorPF,VL_PagadorPJ,QT_PagadorPJ,VL_RecebedorPF,QT_RecebedorPF,VL_RecebedorPJ,QT_RecebedorPJ")
  
  resp <- httr::GET(url)
  stop_for_status(resp)
  
  dados <- content(resp, as = "text", encoding = "UTF-8")
  lis <- fromJSON(dados, flatten = TRUE)
  
  dt <- as.data.table(lis$value)

  return(dt[])
}

```

```{r}
#Rodando fun√ß√£o para coletar dados de transa√ß√µes do PIX:
codibge <- unique(df$i_CodIBGE)

lista_pix <- list()
i_processados <- list()
                     
#Fazendo loop para pegar informa√ß√µes de cada munic√≠pio:

for (i in seq_along(codibge)) {
  munic <- codibge[i]

  # Pula se j√° processado
  if (munic %in% i_processados) {
    message("‚è≠Ô∏è J√° processado: ", munic)
    next
  }

  message("üîÑ Coletando: ", munic)

  # Coleta com tratamento de erro
  resultado <- tryCatch({
    coletar_pix(munic)
  }, error = function(e) {
    message("‚ùå Erro com ", munic, ": ", conditionMessage(e))
    return(NULL)
  })

  # Se obteve resultado, salva na lista
  if (!is.null(resultado)) {
    lista_pix[[as.character(munic)]] <- resultado
    message("‚úîÔ∏è Sucesso: ", munic)

    # Atualiza vetor de processados
    i_processados <- c(i_processados, munic)}
  saveRDS(lista_pix, here("DadosTratados/lista_pix.RDS"))
  saveRDS(i_processados, here("DadosTratados/i_processados.RDS"))

}


# Unindo todos os data.tables do pix
pix <- rbindlist(lista_pix)

saveRDS(pix, here("DadosTratados/pix.RDS"))


rm(codibge, coletar_pix, i, i_processados, munic, resultado, lista_pix)
```

```{r}

pix <- readRDS(here("DadosTratados/pix.RDS"))

#Sumarizando os resultados por munic√≠pio e ano
##C√≥digo: Pagador/Recebedor - PF/PJ - Valor/Quantidade 
pix <- pix[, `:=`(i_CodIBGE = as.numeric(Municipio_Ibge),
        t_Ano = as.numeric(substr(AnoMes, 1, 4)))]

pix <- pix[, .(
        y3_111Pix_VL_PagadorPF = sum(VL_PagadorPF, na.rm = TRUE), 
        y3_112Pix_QT_PagadorPF = sum(QT_PagadorPF, na.rm = TRUE),
        y3_121Pix_VL_PagadorPJ = sum(VL_PagadorPJ, na.rm = TRUE),
        y3_122Pix_QT_PagadorPJ = sum(QT_PagadorPJ, na.rm = TRUE),
        y3_211Pix_VL_RecebedorPF = sum(VL_RecebedorPF, na.rm = TRUE),
        y3_212Pix_QT_RecebedorPF = sum(QT_RecebedorPF, na.rm = TRUE),
        y3_221Pix_VL_RecebedorPJ = sum(VL_RecebedorPJ, na.rm = TRUE),
        y3_222Pix_QT_RecebedorPJ = sum(QT_RecebedorPJ, na.rm = TRUE)),
    by = .(i_CodIBGE, t_Ano)]
  
#Juntando √† base df:
setkey(df, i_CodIBGE, t_Ano)
setkey(pix, i_CodIBGE, t_Ano)

df <- merge(df, pix, by = c("i_CodIBGE", "t_Ano"), all.x = TRUE)

# Removendo a lista de pix e o objeto df
rm(pix)
```

## y4: Volume de ISS

```{r}

```

## y5: N√∫mero de estabelecimentos registrados no munic√≠pio

```{r}
# 1. Defina o projeto no Google Cloud
set_billing_id("jevy-cidades")  # <- seu ID de projeto

# 2. Escreva a query desejada
query <- "
WITH 
dicionario_natureza_estabelecimento AS (
    SELECT
        chave AS chave_natureza_estabelecimento,
        valor AS descricao_natureza_estabelecimento
    FROM `basedosdados.br_me_rais.dicionario`
    WHERE
        nome_coluna = 'natureza_estabelecimento'
        AND id_tabela = 'microdados_estabelecimentos'
)

SELECT
    dados.ano AS ano,
    dados.id_municipio AS id_municipio,
    diretorio_id_municipio.nome AS municipio_nome,
    dados.quantidade_vinculos_ativos AS quantidade_vinculos_ativos,
    descricao_natureza_estabelecimento AS natureza_estabelecimento

FROM `basedosdados.br_me_rais.microdados_estabelecimentos` AS dados

LEFT JOIN (
    SELECT DISTINCT id_municipio, nome  
    FROM `basedosdados.br_bd_diretorios_brasil.municipio`
) AS diretorio_id_municipio
    ON dados.id_municipio = diretorio_id_municipio.id_municipio

LEFT JOIN dicionario_natureza_estabelecimento
    ON dados.natureza_estabelecimento = chave_natureza_estabelecimento
"

# 3. Rodar a query e carregar dados
RAIS <- read_sql(query, billing_project_id = get_billing_id())

setDT(RAIS)
saveRDS(RAIS, here("DadosTratados/RAIS.RDS"))

rm(query)
```

```{r}

RAIS <- RAIS[ano >= 2005]

#Verificando n√∫mero de estabelecimentos
y5 <- RAIS[, .(y5_RAIS_N_Estabelecimentos = .N), by = .(i_CodIBGE = id_municipio, t_Ano = ano)]

y5 <- y5[, .(i_CodIBGE = as.numeric(i_CodIBGE), 
             t_Ano = as.numeric(t_Ano), 
             y5_RAIS_N_Estabelecimentos)]

df <- merge(df, y5, by = c("i_CodIBGE", "t_Ano"), all.x = T)

rm(y5)
```

## y6: Percentual de empregados formais

```{r}
#N√∫mero de V√≠nculos Ativos na RAIS
y6 <- RAIS[, .(y6_RAIS_N_Vinculos = sum(quantidade_vinculos_ativos)), by = .(i_CodIBGE = id_municipio, t_Ano = ano)]

y6 <- y6[, .(i_CodIBGE = as.numeric(i_CodIBGE), 
             t_Ano = as.numeric(t_Ano), 
             y6_RAIS_N_Vinculos)]

df <- merge(df, y6, by = c("i_CodIBGE", "t_Ano"), all.x = T)

rm(y6, RAIS)

```

# Vari√°veis de Controle

## z1: Popula√ß√£o

```{r}
#Levantando a base

z1_1 <- read_xlsx(here("Dados/tabela4709.xlsx"), skip = 2) %>% 
  data.table()

z1_2 <- read_xlsx(here("Dados/tabela6579.xlsx"), skip = 2) %>%
  data.table()

#Renomeando colunas de z1_2:
z1_2 <- z1_2[, .(i_CodIBGE = as.numeric(`C√≥d.`),
         "2013" = Ano,
         "2014" = ...5, 
         "2015" = ...6, 
         "2016" = ...7,
         "2017" = ...8,
         "2018" = ...9, 
         "2019" = ...10, 
         "2020" = ...11, 
         "2021" = ...12, 
         "2024" = ...13)]

#Pivot_longer dos anos
z1_2 <- melt(z1_2, id.vars = "i_CodIBGE", variable.name = "t_Ano", value.name = "z1_Populacao")

z1_2[, t_Ano := as.numeric(as.character(t_Ano))]

#Tratando z1_1:
z1_1 <- z1_1[, .(i_CodIBGE = as.numeric(`C√≥d.`),
         "z1_Populacao" = Ano,
         "t_Ano" = 2022)]

z1 <- bind_rows(z1_1, z1_2)

df <- merge(df, z1, by = c("i_CodIBGE", "t_Ano"), all.x = T) 

df[, z1_Populacao := as.numeric(z1_Populacao)]

rm(z1, z1_1, z1_2)
```

### Adicionando o PIB per capita:

```{r}
df[, y3_PIBperCap := y3_1PIBtotal / z1_Populacao]

```

## z2: √Årea e Densidade Populacional

```{r}

# Lendo arquivos:
area_files <- list.files(here("Dados/IBGE_Area_Municipios/"), pattern = "\\.xls[x]?$", full.names = TRUE)

area_data <- lapply(area_files, read_excel)
#Adicionando nomes
names(area_data) <- area_files %>%
  basename() %>%
  file_path_sans_ext()


```

```{r}
#Limpando manualmente
#2010
z2 <- area_data$Areas_MU_UF_RE_BR %>% 
  data.table()

z2 <- z2[, .(i_CodIBGE = as.numeric(GEOCODIGO),
          t_Ano = 2010,
          z2_1AreaMun = as.numeric(AR_MUN_2010))]

#2013
z2_ano <- area_data$Areas_BR_RG_UF_MUN_2013 %>% 
  data.table()

z2_ano <- z2_ano[, .(i_CodIBGE = as.numeric(CD_GEOCODIGO),
          t_Ano = 2013,
          z2_1AreaMun = as.numeric(AREA_2013_KM2))]

z2 <- bind_rows(z2, z2_ano)

#2014
z2_ano <- area_data$Areas_MU_UF_RE_BR_2014 %>% 
  data.table()

z2_ano <- z2_ano[, .(i_CodIBGE = as.numeric(CD_GCMUN),
          t_Ano = 2014,
          z2_1AreaMun = as.numeric(AR_MUN_2014))]

z2 <- bind_rows(z2, z2_ano)

#2015

z2_ano <- area_data$AR_BR_RG_UF_MUN_2015 %>% 
  data.table()

z2_ano <- z2_ano[, .(i_CodIBGE = as.numeric(CD_GCMUN),
          t_Ano = 2015,
          z2_1AreaMun = as.numeric(AR_MUN_2015))]

z2 <- bind_rows(z2, z2_ano)


#2016

z2_ano <- area_data$AR_BR_RG_UF_MUN_2016 %>% 
  data.table()

z2_ano <- z2_ano[, .(i_CodIBGE = as.numeric(CD_GCMUN),
          t_Ano = 2016,
          z2_1AreaMun = as.numeric(AR_MUN_2016))]

z2 <- bind_rows(z2, z2_ano)

#2017

z2_ano <- area_data$AR_BR_RG_UF_MES_MIC_MUN_2017 %>% 
  data.table()

z2_ano <- z2_ano[, .(i_CodIBGE = as.numeric(CD_GCMUN),
          t_Ano = 2017,
          z2_1AreaMun = as.numeric(AR_MUN_2017))]

z2 <- bind_rows(z2, z2_ano)


#2018

z2_ano <- area_data$AR_BR_RG_UF_MES_MIC_MUN_2018 %>% 
  data.table()

z2_ano <- z2_ano[, .(i_CodIBGE = as.numeric(CD_GCMUN),
          t_Ano = 2018,
          z2_1AreaMun = as.numeric(AR_MUN_2018))]

z2 <- bind_rows(z2, z2_ano)

#2019

z2_ano <- area_data$AR_BR_RG_UF_RGINT_RGIM_MES_MIC_MUN_2019 %>% 
  data.table()

z2_ano <- z2_ano[, .(i_CodIBGE = as.numeric(CD_GCMUN),
          t_Ano = 2019,
          z2_1AreaMun = as.numeric(AR_MUN_2019))]

z2 <- bind_rows(z2, z2_ano)

#2020

z2_ano <- area_data$AR_BR_RG_UF_RGINT_RGIM_MES_MIC_MUN_2020 %>% 
  data.table()

z2_ano <- z2_ano[, .(i_CodIBGE = as.numeric(CD_GCMUN),
          t_Ano = 2020,
          z2_1AreaMun = as.numeric(AR_MUN_2020))]

z2 <- bind_rows(z2, z2_ano)

#2021

z2_ano <- area_data$AR_BR_RG_UF_RGINT_RGIM_MES_MIC_MUN_2021 %>% 
  data.table()

z2_ano <- z2_ano[, .(i_CodIBGE = as.numeric(CD_MUN),
          t_Ano = 2021,
          z2_1AreaMun = as.numeric(AR_MUN_2021))]

z2 <- bind_rows(z2, z2_ano)

#2022

z2_ano <- area_data$AR_BR_RG_UF_RGINT_MES_MIC_MUN_2022 %>% 
  data.table()

z2_ano <- z2_ano[, .(i_CodIBGE = as.numeric(CD_MUN),
          t_Ano = 2022,
          z2_1AreaMun = as.numeric(AR_MUN_2022))]

z2 <- bind_rows(z2, z2_ano)

#2023

z2_ano <- area_data$AR_BR_RG_UF_RGINT_RGI_MUN_2023 %>% 
  data.table()

z2_ano <- z2_ano[, .(i_CodIBGE = as.numeric(CD_MUN),
          t_Ano = 2023,
          z2_1AreaMun = as.numeric(AR_MUN_2023))]

z2 <- bind_rows(z2, z2_ano)

#2024

z2_ano <- area_data$AR_BR_RG_UF_RGINT_RGI_MUN_2024 %>% 
  data.table()

z2_ano <- z2_ano[, .(i_CodIBGE = as.numeric(CD_MUN),
          t_Ano = 2024,
          z2_1AreaMun = as.numeric(AR_MUN_2024))]

z2 <- bind_rows(z2, z2_ano)

rm(z2_ano, area_data, area_files)

```

```{r}
#Juntando √† base principal

df <- merge(df, z2, by = c("i_CodIBGE", "t_Ano"), all.x = T)

df[ , z2_2DensidadeDemografica := z1_Populacao / z2_1AreaMun]


rm(z2)

```

## z3: Frota de Ve√≠culos per Capita

```{r}

# Defina o seu projeto no Google Cloud
set_billing_id("jevy-cidades")

# Para carregar o dado direto no R
query <- "
SELECT
    dados.ano as ano,
    dados.id_municipio AS id_municipio,
    diretorio_id_municipio.nome AS id_municipio_nome,
    dados.tipo_veiculo as tipo_veiculo,
    dados.quantidade as quantidade
FROM `basedosdados.br_denatran_frota.municipio_tipo` AS dados
LEFT JOIN (SELECT DISTINCT id_municipio,nome  FROM `basedosdados.br_bd_diretorios_brasil.municipio`) AS diretorio_id_municipio
    ON dados.id_municipio = diretorio_id_municipio.id_municipio"

z3 <- read_sql(query, billing_project_id = get_billing_id())
setDT(z3)

unique(z3$tipo_veiculo)
```

```{r}

#Juntando categorias de ve√≠culos
z3 <- z3[, z3_tipo_veiculo := fcase(
  tipo_veiculo %in% c("automovel"), "automovel",
  tipo_veiculo %in% c("motocicleta"), "moto",
  tipo_veiculo %in% c("onibus", "micro-onibus"), "onibus",
  default = "outros")]

z3 <- dcast(z3,
  ... ~ z3_tipo_veiculo,
  value.var = "quantidade",
  fun.aggregate = sum,
  fill = 0)


z3 <- z3[, .(z3_1N_Automovel = sum(automovel), z3_2N_Moto = sum(moto),
              z3_3N_Onibus = sum(onibus), z3_4N_Outros = sum(outros)), 
          by = c(i_CodIBGE = "id_municipio", t_Ano = "ano")]

z3 <- z3[, i_CodIBGE := as.numeric(i_CodIBGE)]

#Juntando √† base df:
df <- merge(df, z3, by = c("i_CodIBGE", "t_Ano"), all.x = T)

rm(z3, query)
```

## z4: Venda de combust√≠veis f√≥sseis para os munic√≠pios

```{r}
#Etanol
z4 <- all_data$`vendas-anuais-de-etanol-hidratado-por-municipio` %>% 
  data.table()

z4 <- z4[, .(i_CodIBGE = C√É.DIGO.IBGE,
         t_Ano = ANO,
         z4_1Etanol = VENDAS)]

#Gasolina C
z4_t <- all_data$`vendas-anuais-de-gasolina-c-por-municipio` %>% 
  data.table()

z4_t <- z4_t[, .(i_CodIBGE = C√É.DIGO.IBGE,
         t_Ano = ANO,
         z4_2GasolinaC = VENDAS)]

z4 <- merge(z4, z4_t, by = c("i_CodIBGE", "t_Ano"), all = T)

#GLP
z4_t <- all_data$`vendas-anuais-de-glp-por-municipio` %>% 
  data.table()

z4_t <- z4_t[, .(i_CodIBGE = C√É.DIGO.IBGE,
         t_Ano = ANO,
         z4_31GLP_P13 = P13, 
         z4_32GLP_Outros = OUTROS)]

z4 <- merge(z4, z4_t, by = c("i_CodIBGE", "t_Ano"), all = T)

#√ìleo Combust√≠vel
z4_t <- all_data$`vendas-anuais-de-oleo-combustivel-por-municipio`%>% 
  data.table()

z4_t <- z4_t[, .(i_CodIBGE = C√É.DIGO.IBGE,
         t_Ano = ANO,
         z4_4Oleo_Combustivel = VENDAS)]

z4 <- merge(z4, z4_t, by = c("i_CodIBGE", "t_Ano"), all = T)

#√ìleo Disel
z4_t <- all_data$`vendas-anuais-de-oleo-diesel-por-municipio`%>% 
  data.table()

z4_t <- z4_t[, .(i_CodIBGE = C√É.DIGO.IBGE,
         t_Ano = ANO,
         z4_5Diesel = VENDAS)]

z4 <- merge(z4, z4_t, by = c("i_CodIBGE", "t_Ano"), all = T)

#Juntando √† df:

df <- merge(df, z4, by = c("i_CodIBGE", "t_Ano"), all.x = T)

rm(z4, z4_t)

```

## z5: Fuzzy de √Årea Urbana, Rural e Natural

```{r}
z5 <- all_data$BD11_Id_Geocodigos_Nome_Tipo %>% 
  data.table()

z5 <- z5[, .(i_CodIBGE = Cod_Mun,
             t_Ano = 2023,
             z5_1Area_Urbana = `FZZ_URB_%`, 
             z5_2Area_Rural = `FZZ_RUR_%`,
             z5_3Area_Natural = `FZZ_NAT_%`)]

df <- merge(df, z5, by = c("i_CodIBGE", "t_Ano"), all.x = T)

rm(z5)
```

## z6: √çndice de Desenvolvimento Sustent√°vel das Cidades

```{r}
#Dados de 2022
z6 <- read_xlsx(here("Dados/Base_de_Dados_IDSC-BR_2022.xlsx"), sheet = "Todos os Dados") %>% 
  data.table()

z6 <- z6[, .(i_CodIBGE = id,
       t_Ano = 2022,
       z6_IDSC = `Pontua√ß√£o IDSC-BR`)]

#Dados de 2023
z6_23 <- read_xlsx(here("Dados/Base_de_Dados_IDSC-BR_2023.xlsx"), sheet = "Todos os Dados") %>% 
  data.table()

z6_23 <- z6_23[, .(i_CodIBGE = id,
       t_Ano = 2023,
       z6_IDSC = `Pontua√ß√£o Indice ODS 2023`)]

z6 <- bind_rows(z6, z6_23)

#Dados de 2024
z6_24 <- read_xlsx(here("Dados/Base_de_Dados_IDSC-BR_2024.xlsx"), sheet = "IDSC-BR 2024") %>% 
  data.table()

z6_24 <- z6_24[, .(i_CodIBGE = COD_MUN,
       t_Ano = 2024,
       z6_IDSC = `IDSC-BR 2024`)]

z6 <- bind_rows(z6, z6_24)

#Adicionando √† base df:

df <- merge(df, z6, by = c("i_CodIBGE", "t_Ano"), all.x = T)

rm(z6, z6_23, z6_24)
```

# Reordenando colunas

```{r}
# Identificando colunas das vari√°veis
xyz_cols <- grep("^[xyz]", names(df), value = TRUE)

# Ordenando colunas alfabeticamente
xyz_cols <- sort(xyz_cols)

# Selecionando outras colunas
demais_cols <- setdiff(names(df), xyz_cols)

# Reorderando as colunas
setcolorder(df, c(demais_cols, xyz_cols))

rm(xyz_cols, demais_cols)

saveRDS(df, here("DadosTratados/df.RDS"))


```
